---
title: "R : Survival Analysis and Descriptive Modelling for a Two-Group Right-Censored
  Data with Time-Independent Variables Using Cox Proportional Hazards Model"
author: "John Pauline Pineda"
date: "May 5, 2022"
output: 
  html_document:
    toc: true
    toc_depth: 3
    theme: readable
    highlight: tango
    css: doc.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=15, fig.height=10)
```
# **1. Table of Contents**
|
| This project implements the survival analysis and descriptive modelling steps for a two-group right-censored data with time-independent variables using the **Cox Proportional Hazards Model** with various helpful packages in <mark style="background-color: #CCECFF">**R**</mark>. The **Kaplan-Meier Survival Curves** and **Log-Rank Test** were applied during the differential analysis of the survival data between groups. All predictors’ prognostic significance were individually and simultaneously evaluated using **Univariate and Multivariate Cox Proportional Hazards Models**, respectively. The discrimination power of the resulting models were assessed using the **Harrel’s Concordance Index**. The final prognostic model was internally validated using Bootstrap Validation with Optimism Estimation and evaluated for compliance on all required model assumptions using the appropriate diagnostics.
|
| Survival analysis corresponds to a set of statistical approaches for time-to-event data, where the outcome variable of interest is the time until an event occurs. Descriptive modelling involves the formulation of statistical models to identify patterns and relationships that can be used for statistical inferences given the predictors and response variables. The methods applied in this study (mostly contained in the <mark style="background-color: #CCECFF">**survival**</mark> package) attempt to explore the relationship between factors and both the survival time and event outcomes, while evaluating their effects through statistical hypotheses testing.
|
##  1.1 Sample Data
|
| The <mark style="background-color: #EEEEEE;color: #FF0000">**Leukemia**</mark> dataset from the book  <mark style="background-color: #CCECFF">**Survival Analysis : A Self-Learning Text**</mark> was used for this illustrated example.
|
| Preliminary dataset assessment:
|
| **[A]** 42 Rows (observations composed of leukemia patients enrolled in the study)
|
| **[B]** 4 Columns (variables)
|      **[B.1]** 1/4 Factor variable = <span style="color: #FF0000">Group</span> (factor)
|           **[B.1.1]** <span style="color: #FF0000">Placebo</span> = placebo drug treatment
|           **[B.1.2]** <span style="color: #FF0000">Treatment</span> = new drug treatment
|      **[B.2]** 1/4 Censoring variable = <span style="color: #FF0000">Status</span> (factor)
|           **[B.2.1]** <span style="color: #FF0000">1</span> = event, patient went out of remission before the end of the study
|           **[B.2.2]** <span style="color: #FF0000">0</span> = censored or non-event, patient remains in remission until the end of the study, lost to follow-up, experiences a different event that makes further follow-up impossible or withdraws before the end of the study
|      **[B.3]** 1/4 Response variables = <span style="color: #FF0000">Week</span> (numeric)
|           **[B.3.1]** <span style="color: #FF0000">Week</span> = time in weeks a patient is in remission up to the point of the patient’s either going out of remission or being censored
|      **[B.4]** 1/4 Covariate variable = <span style="color: #FF0000">WBC</span> (numeric)
|           **[B.4.1]** <span style="color: #FF0000">WBC</span> = logarithm-transformed white blood cell measurement data gathered before the study which is also considered an important survival predictor in leukemia patients
|
```{r section_1.1, warning=FALSE, message=FALSE}
##################################
# Loading R libraries
##################################
library(moments)
library(car)
library(multcomp)
library(effects)
library(psych)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(rstatix)
library(ggfortify)
library(trend)
library(survival)
library(rms)
library(survminer)
library(Hmisc)
library(finalfit)
library(knitr)
library(gtsummary)


##################################
# Setting the working directory
##################################
setwd("D:/R_Codes/Markdown/SurvivalAnalysis")

##################################
# Reading and creating the complete dataset
##################################
DBP.Complete <- read.csv('Leukemia.csv',
                na.strings=c("NA","NaN"," ",""),
                stringsAsFactors = T)

##################################
# Performing a general exploration of the dataset
##################################
dim(DBP.Complete)
str(DBP.Complete)
summary(DBP.Complete)

##################################
# Setting the levels for the treatment categories
##################################
DBP.Complete$Group <- factor(DBP.Complete$Group,
                           levels = c("Placebo","Treatment"))

DBP.Complete$StatusLevel <- factor(DBP.Complete$Status,
                            levels = c(0,1))

##################################
# Creating an analysis dataset without the subject information column
##################################
DBP.Analysis <- DBP.Complete[,-1]

##################################
# Creating a response-covariate dataset without the treatment column
##################################
DBP.Response.Covariate <- DBP.Analysis[,-1]

##################################
# Formulating a data type assessment summary
##################################
PDA <- DBP.Response.Covariate
(PDA.Summary <- data.frame(
  Column.Index=c(1:length(names(PDA))),
  Column.Name= names(PDA), 
  Column.Type=sapply(PDA, function(x) class(x)), 
  row.names=NULL)
)

```

##  1.2 Data Quality Assessment
|
| Data quality assessment:
|
| **[A]** No missing observations noted for any response and covariate variable.
|
| **[B]** No low variance (Unique.Count.Ratio<0.01 or First.Second.Mode.Ratio>5) noted for any response variable.
|
| **[C]** No high skewness (Skewness>3 or Skewness<(-3)) noted for any response variable.
|
```{r section_1.2, warning=FALSE, message=FALSE}
##################################
# Restoring the working directory
##################################
setwd("D:/R_Codes/Markdown")

##################################
# Reusing the response-covariate dataset
##################################
DQA <- DBP.Response.Covariate

##################################
# Formulating a data subset of response variables (numeric)
##################################
DQA.Variables.Response <- as.data.frame(DQA$Week)

##################################
# Formulating a data subset of covariate variables (numeric)
##################################
DQA.Variables.Covariate.Numeric <- as.data.frame(DQA$WBC)

##################################
# Formulating an overall data quality assessment summary
##################################
(DQA.Summary <- data.frame(
  Column.Index=c(1:length(names(DQA))),
  Column.Name= names(DQA), 
  Column.Type=sapply(DQA, function(x) class(x)), 
  Row.Count=sapply(DQA, function(x) nrow(DQA)),
  NA.Count=sapply(DQA,function(x)sum(is.na(x))),
  Fill.Rate=sapply(DQA,function(x)format(round((sum(!is.na(x))/nrow(DQA)),3),nsmall=3)),
  row.names=NULL)
)

##################################
# Checking for missing observations
##################################
if ((nrow(DQA.Summary[DQA.Summary$NA.Count>0,]))>0){
  print(paste0("Missing observations noted for ",
               (nrow(DQA.Summary[DQA.Summary$NA.Count>0,])),
               " variable(s) with NA.Count>0 and Fill.Rate<1.0."))
  DQA.Summary[DQA.Summary$NA.Count>0,]
} else {
  print("No missing observations noted.")
}

##################################
# Formulating a data quality assessment summary for response variables (numeric)
##################################

if (length(names(DQA.Variables.Response))>0) {
  
  ##################################
  # Formulating a function to determine the first mode
  ##################################
  FirstModes <- function(x) {
    ux <- unique(na.omit(x))
    tab <- tabulate(match(x, ux))
    ux[tab == max(tab)]
  }

  ##################################
  # Formulating a function to determine the second mode
  ##################################
  SecondModes <- function(x) {
    ux <- unique(na.omit(x))
    tab <- tabulate(match(x, ux))
    fm = ux[tab == max(tab)]
    sm = na.omit(x)[!(na.omit(x) %in% fm)]
    usm <- unique(sm)
    tabsm <- tabulate(match(sm, usm))
    usm[tabsm == max(tabsm)]
  }
  
  (DQA.Variables.Response.Summary <- data.frame(
  Column.Name= names(DQA.Variables.Response), 
  Column.Type=sapply(DQA.Variables.Response, function(x) class(x)), 
  Unique.Count=sapply(DQA.Variables.Response, function(x) length(unique(x))),
  Unique.Count.Ratio=sapply(DQA.Variables.Response, function(x) format(round((length(unique(x))/nrow(DQA.Variables.Response)),3), nsmall=3)),
  First.Mode.Value=sapply(DQA.Variables.Response, function(x) format(round((FirstModes(x)[1]),3),nsmall=3)),
  Second.Mode.Value=sapply(DQA.Variables.Response, function(x) format(round((SecondModes(x)[1]),3),nsmall=3)),
  First.Mode.Count=sapply(DQA.Variables.Response, function(x) sum(na.omit(x) == FirstModes(x)[1])),
  Second.Mode.Count=sapply(DQA.Variables.Response, function(x) sum(na.omit(x) == SecondModes(x)[1])),
  First.Second.Mode.Ratio=sapply(DQA.Variables.Response, function(x) format(round((sum(na.omit(x) == FirstModes(x)[1])/sum(na.omit(x) == SecondModes(x)[1])),3), nsmall=3)),
  Minimum=sapply(DQA.Variables.Response, function(x) format(round(min(x,na.rm = TRUE),3), nsmall=3)),
  Mean=sapply(DQA.Variables.Response, function(x) format(round(mean(x,na.rm = TRUE),3), nsmall=3)),
  Median=sapply(DQA.Variables.Response, function(x) format(round(median(x,na.rm = TRUE),3), nsmall=3)),
  Maximum=sapply(DQA.Variables.Response, function(x) format(round(max(x,na.rm = TRUE),3), nsmall=3)),
  Skewness=sapply(DQA.Variables.Response, function(x) format(round(skewness(x,na.rm = TRUE),3), nsmall=3)),
  Kurtosis=sapply(DQA.Variables.Response, function(x) format(round(kurtosis(x,na.rm = TRUE),3), nsmall=3)),
  Percentile25th=sapply(DQA.Variables.Response, function(x) format(round(quantile(x,probs=0.25,na.rm = TRUE),3), nsmall=3)),
  Percentile75th=sapply(DQA.Variables.Response, function(x) format(round(quantile(x,probs=0.75,na.rm = TRUE),3), nsmall=3)),
  row.names=NULL)
  )  
  
}

##################################
# Identifying potential data quality issues for response variables (numeric) 
##################################

##################################
# Checking for zero or near-zero variance predictors
##################################
if (length(names(DQA.Variables.Response))==0) {
  print("No numeric predictors noted.")
} else if (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$First.Second.Mode.Ratio))>5,])>0){
  print(paste0("Low variance observed for ",
               (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$First.Second.Mode.Ratio))>5,])),
               " numeric variable(s) with First.Second.Mode.Ratio>5."))
  DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$First.Second.Mode.Ratio))>5,]
} else {
  print("No low variance numeric predictors due to high first-second mode ratio noted.")
}

if (length(names(DQA.Variables.Response))==0) {
  print("No numeric predictors noted.")
} else if (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Unique.Count.Ratio))<0.01,])>0){
  print(paste0("Low variance observed for ",
               (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Unique.Count.Ratio))<0.01,])),
               " numeric variable(s) with Unique.Count.Ratio<0.01."))
  DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Unique.Count.Ratio))<0.01,]
} else {
  print("No low variance numeric predictors due to low unique count ratio noted.")
}

##################################
# Checking for skewed response variables
##################################
if (length(names(DQA.Variables.Response))==0) {
  print("No response variables noted.")
} else if (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))>3 |
                                               as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))<(-3),])>0){
  print(paste0("High skewness observed for ",
  (nrow(DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))>3 |
                                               as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))<(-3),])),
  " response variable(s) with Skewness>3 or Skewness<(-3)."))
  DQA.Variables.Response.Summary[as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))>3 |
                                 as.numeric(as.character(DQA.Variables.Response.Summary$Skewness))<(-3),]
} else {
  print("No skewed response variables noted.")
}

```

##  1.3 Research Question
|
| Using the <mark style="background-color: #EEEEEE;color: #FF0000">**Leukemia**</mark> dataset, survival analysis and modelling will be conducted to investigate the following :
|
| **[A]** Research Question : What is the probability that a leukemia patient under the <span style="color: #FF0000">Treatment</span> and <span style="color: #FF0000">Placebo</span> groups will survive (remain in remission) after a specified number of weeks?   
|      **[A.1]** Factor variable = <span style="color: #FF0000">Group</span>
|           **[A.1.1]** <span style="color: #FF0000">Placebo</span> = placebo drug treatment
|           **[A.1.2]** <span style="color: #FF0000">New</span> = new drug treatment
|      **[A.2]** Response variable = <span style="color: #FF0000">Week</span> (numeric)
|      **[A.3]** Censoring variable = <span style="color: #FF0000">Status</span> (factor)
|           **[A.3.1]** <span style="color: #FF0000">1</span> = event, patient went out of remission before the end of the study
|           **[A.3.2]** <span style="color: #FF0000">0</span> = censored or non-event, patient remains in remission until the end of the study, lost to follow-up, experiences a different event that makes further follow-up impossible or withdraws before the end of the study
|
| **[B]** Research Question : Are there differences in survival between leukemia patients under the <span style="color: #FF0000">Treatment</span> and <span style="color: #FF0000">Placebo</span> groups?  
|      **[B.1]** Factor variable = <span style="color: #FF0000">Group</span>
|           **[B.1.1]** <span style="color: #FF0000">Placebo</span> = placebo drug treatment
|           **[B.1.2]** <span style="color: #FF0000">Treatment</span> = new drug treatment
|      **[B.2]** Response variable = <span style="color: #FF0000">Week</span> (numeric)
|      **[B.3]** Censoring variable = <span style="color: #FF0000">Status</span> (factor)
|           **[B.3.1]** <span style="color: #FF0000">1</span> = event, patient went out of remission before the end of the study
|           **[B.3.2]** <span style="color: #FF0000">0</span> = censored or non-event, patient remains in remission until the end of the study, lost to follow-up, experiences a different event that makes further follow-up impossible or withdraws before the end of the study
|
| **[C]** Research Question : What is the impact of the clinical characteristic <span style="color: #FF0000">WBC</span> on the survival of leukemia patients under the <span style="color: #FF0000">Treatment</span> and <span style="color: #FF0000">Placebo</span> groups?
|      **[C.1]** Factor variable = <span style="color: #FF0000">Group</span>
|           **[C.1.1]** <span style="color: #FF0000">Placebo</span> = placebo drug treatment
|           **[C.1.2]** <span style="color: #FF0000">Treatment</span> = new drug treatment
|      **[C.2]** Response variable = <span style="color: #FF0000">Week</span> (numeric)
|      **[C.3]** Censoring variable = <span style="color: #FF0000">Status</span> (factor)
|           **[C.3.1]** <span style="color: #FF0000">1</span> = event, patient went out of remission before the end of the study
|           **[C.3.2]** <span style="color: #FF0000">0</span> = censored or non-event, patient remains in remission until the end of the study, lost to follow-up, experiences a different event that makes further follow-up impossible or withdraws before the end of the study
|      **[C.4]** Covariate variable = <span style="color: #FF0000">WBC</span> (numeric) = logarithm-transformed white blood cell measurement data gathered before the study which is also considered an important survival predictor in leukemia patients
|
##  1.4 Data Exploration
|
| Exploratory and comparative analyses of the response variable <span style="color: #FF0000">Week</span> by factor variable <span style="color: #FF0000">Group</span> showed that :
|
| **[A]** Differences in the proportion of censored and uncensored data (p<0.001, Pearson's Chi-squared Test) observed between <span style="color: #FF0000">Group=Treatment</span> (censored=57%, uncensored=43%) and <span style="color: #FF0000">Group=Placebo</span> (censored=0%, uncensored=100%). 
|
| **[B]** With both censored and uncensored data considered, higher median survival time <span style="color: #FF0000">Week</span> (p=0.004, Wilcoxon Rank Sum Test) was observed for <span style="color: #FF0000">Group=Treatment</span> (16) as compared to <span style="color: #FF0000">Group=Placebo</span> (8). Lower median white blood cell measurement <span style="color: #FF0000">WBC</span> (p=0.047, Wilcoxon Rank Sum Test) was also noted for <span style="color: #FF0000">Group=Treatment</span> (2.57) as compared to <span style="color: #FF0000">Group=Placebo</span> (3.06). 
|
| **[C]** With only the uncensored considered, higher mean survival time <span style="color: #FF0000">Week</span> observed for <span style="color: #FF0000">Group=Treatment</span> (12.11) as compared to <span style="color: #FF0000">Group=Placebo</span> (8.67). Lower mean hazard rate was also noted for <span style="color: #FF0000">Group=Treatment</span> (2.51) as compared to <span style="color: #FF0000">Group=Placebo</span> (11.53).
|
| Kaplan-Meier survival curve analysis of  the response variable <span style="color: #FF0000">Week</span> by factor variable <span style="color: #FF0000">Group</span> (with censoring variable <span style="color: #FF0000">Status</span> considered) showed that :
|
| **[A]** Differences in the Kaplan-Meier survival curves (p<0.0001, Log Rank Test) were noted between <span style="color: #FF0000">Group=Treatment</span> (median survival time=23) and <span style="color: #FF0000">Group=Placebo</span> (median survival time=8).
|
| **[B]** Higher survival time was consistently observed for leukemia patients under <span style="color: #FF0000">Group=Treatment</span> as compared to those under <span style="color: #FF0000">Group=Placebo</span> at various sampled durations including <span style="color: #FF0000">Week=5</span> (Treatment=100%, Placebo=57%), <span style="color: #FF0000">Week=10</span> (Treatment=75%, Placebo=38%), <span style="color: #FF0000">Week=15</span> (Treatment=69%, Placebo=14%), <span style="color: #FF0000">Week=20</span> (Treatment=63%, Placebo=10%) and <span style="color: #FF0000">Week=23</span> (Treatment=45%, Placebo=0%).
|
### 1.4.1 Descriptive Statistics
```{r section_1.4.1, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Reusing the dataset
##################################
head(DBP.Analysis)

##################################
# Formulating a preliminary summary
# of descriptive statistics 
##################################

DBP.Analysis %>%
  select(Week,StatusLevel,WBC,Group) %>%
  tbl_summary(
    by = Group,
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c("{N_nonmiss}",
                                     "{mean} ({sd})", 
                                     "{median} ({p25}, {p75})", 
                                     "{min}, {max}"),
    missing = "no") %>% 
  add_overall() %>% 
  add_p()

##################################
# Computing for the mean uncensored survival time
# and mean hazard rate between treatment and placebo groups
##################################
DBP.Analysis.DescriptiveStatistics <- DBP.Analysis %>%
  group_by(Group) %>%
  summarise(
    Mean.Uncensored.Survival.Time = mean(Week[Status==1]),
    Total.Uncensored.Survival.Time = sum(Status==1),
    Total.Survival.Time = sum(Week),
    Mean.Hazard.Rate = (Total.Uncensored.Survival.Time/Total.Survival.Time)*100)

kable(DBP.Analysis.DescriptiveStatistics)

```

### 1.4.2 Kaplan-Meier Survival Curve
```{r section_1.4.2, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Reusing the dataset
##################################
head(DBP.Analysis)

##################################
# Computing the Kaplan-Meier survival estimates
# using the Baseline data
##################################
DBP.Analysis.Baseline.KaplanMeierEstimates <- survfit(Surv(Week, Status) ~ 1, data = DBP.Analysis)
print(DBP.Analysis.Baseline.KaplanMeierEstimates)

tbl_survfit(DBP.Analysis.Baseline.KaplanMeierEstimates,
            times = c(5,10,15,20,23),
            label_header = "**Week {time}**"
)

##################################
# Formulating a summary of the Kaplan-Meier survival estimates
# using the Baseline data
##################################
summary(DBP.Analysis.Baseline.KaplanMeierEstimates)
(DBP.Analysis.Baseline.KaplanMeierEstimates.Summary <- summary(DBP.Analysis.Baseline.KaplanMeierEstimates)$table)

##################################
# Listing the details of the Kaplan-Meier survival estimates
# using the Baseline data
##################################
(DBP.Analysis.Baseline.KaplanMeierEstimates.Details <- surv_summary(DBP.Analysis.Baseline.KaplanMeierEstimates))

##################################
# Plotting the Kaplan-Meier survival curves
# using the Baseline data
##################################
SurvivalTimeInWeek.KaplanMeier.Baseline <- ggsurvplot(DBP.Analysis.Baseline.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curve (Baseline)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.Baseline,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Computing the Kaplan-Meier survival estimates
# using the Factor Variable
##################################
DBP.Analysis.KaplanMeierEstimates <- survfit(Surv(Week, Status) ~ Group, data = DBP.Analysis)
print(DBP.Analysis.KaplanMeierEstimates)

tbl_survfit(DBP.Analysis.KaplanMeierEstimates,
            times = c(5,10,15,20,23),
            label_header = "**Week {time}**"
)

##################################
# Formulating a summary of the Kaplan-Meier survival estimates
# using the Factor Variable
##################################
summary(DBP.Analysis.KaplanMeierEstimates)
(DBP.Analysis.KaplanMeierEstimates.Summary <- summary(DBP.Analysis.KaplanMeierEstimates)$table)

##################################
# Listing the details of the Kaplan-Meier survival estimates
# using the Factor Variable
##################################
(DBP.Analysis.KaplanMeierEstimates.Details <- surv_summary(DBP.Analysis.KaplanMeierEstimates))

##################################
# Plotting the Kaplan-Meier survival curves
# using the Factor Variable
##################################
SurvivalTimeInWeek.KaplanMeier.ByGroup <- ggsurvplot(DBP.Analysis.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curve (Group)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     legend.labs = c("Placebo", "Treatment"),
                                                     palette = c("#3259A0","#FF5050"))

ggpar(SurvivalTimeInWeek.KaplanMeier.ByGroup,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))
```

### 1.4.3 Log Rank Test
```{r section_1.4.3, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Conducting the Log Rank Test
# between the Kaplan-Meier survival estimates
# using the Factor Variable
##################################
(DBP.Analysis.LogRankTest <- survdiff(Surv(Week, Status) ~ Group, data = DBP.Analysis))

##################################
# Plotting the Kaplan-Meier survival curves
# using the Factor Variable
##################################
SurvivalTimeInWeek.KaplanMeier.ByGroup <- ggsurvplot(DBP.Analysis.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curve (Group)",
                                                     pval = TRUE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     legend.labs = c("Placebo", "Treatment"),
                                                     palette = c("#3259A0","#FF5050"))

ggpar(SurvivalTimeInWeek.KaplanMeier.ByGroup,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

```

##  1.5 Model Development Summary
|
| [Cox Proportional Hazards](https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1972.tb00899.x) examines the relationship between a hazard function and a set of covariates by assuming that predictors act multiplicatively on the hazard function without any explicit assumption of its distributional form. The model is semi-parametric because while the baseline hazard can take any form, the covariates enter the model linearly. 
|
| [Concordance Index](https://jamanetwork.com/journals/jama/article-abstract/372568) is a rank correlation measure between a predictor and a possibly censored outcome with an event or censoring indicator. In survival analysis, a pair of patients is called concordant if the risk of the event predicted by a model is lower for the patient who experiences the event at a later time point. The concordance probability (C-index) is the frequency of concordant pairs among all pairs of subjects which can be used to measure and compare the discrimination power of risk prediction models.
|
| Cox proportional hazards regression analysis involving the response variable <span style="color: #FF0000">Week</span>, factor variable <span style="color: #FF0000">Group</span> and covariate variable <span style="color: #FF0000">WBC</span>  showed that :
|
| **[A]** A cox proportional hazards regression model applied on the response variable <span style="color: #FF0000">Week</span> and factor variable <span style="color: #FF0000">Group</span> which includes the covariate variable <span style="color: #FF0000">WBC</span> was most appropriate as the final survival model since its addition significantly improved model fit (p<0.001, Likelihood Ratio Test). However, the further inclusion of an interaction term <span style="color: #FF0000">Group * WBC</span> into the model did not show any significant improvement to model fit (p=0.549, Likelihood Ratio Test). 
|
| **[B]** Using the final survival model controlled for <span style="color: #FF0000">WBC</span>, association between <span style="color: #FF0000">Group</span> and survival time <span style="color: #FF0000">Week</span> was statistically significant with an estimated hazard ratio of 0.25 (95% CI 0.11, 0.57; p=0.001, Cox Proportional Hazards Model Wald Test) for <span style="color: #FF0000">Group=Treatment</span> (lower hazard and higher survival rate for leukemia patients using the new treatment) relative to <span style="color: #FF0000">Group=Placebo</span> (higher hazard and lower survival rate for leukemia patients using the placebo treatment). 
|
| **[C]** Using the final survival model controlled for <span style="color: #FF0000">Group</span>, association between <span style="color: #FF0000">WBC</span> and survival time <span style="color: #FF0000">Week</span> was statistically significant with an estimated hazard ratio of 5.42 (95% CI 2.81, 10.50; p<0.001, Cox Proportional Hazards Model Wald Test) indicating higher hazard and lower survival rate for leukemia patients with higher white blood count measurement. 
|
| **[D]** The estimated Harrel's concordance index (proportion of leukemia patients that the model can correctly order in terms of survival times when adjusted for censoring) for the final survival model was determined to be relatively high at 0.85 (optimistic) and 0.84 (optimism-corrected after a 500-cycle internal bootstrap validation).
|
| **[E]** The scaled Schoenfield residuals showed random patterns when plotted against time indicating no violation of the proportional hazards assumption. The proportional hazards assumption was further supported by the non-significant relationship between the scaled Schoenfield residuals and time based from the global (p=0.9801) and individual (p=0.9927 for <span style="color: #FF0000">Group</span>, 0.8414 for <span style="color: #FF0000">WBC</span> ) statistical test results. 
|
| **[F]** The deviance residuals did not show any severely influential observations when plotted against the observations, the dfbeta residuals were reasonably symmetrical when plotted against the observations, and the fitted line with lowess function of the martingale residuals obtained for the null cox model was reasonably linear for the numeric covariate <span style="color: #FF0000">WBC</span> - all indicating a fairly good model fit for the final survival model.
|
### 1.5.1 Univariate Cox Proportional Hazards Model
```{r section_1.5.1, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Formulating a Univariate Cox Proportional Hazards Model
# independently for the Factor Variable
##################################
(DBP.Analysis.UnivariateCoxPH.Group <- coxph(Surv(Week, Status) ~ Group, data = DBP.Analysis))

summary(DBP.Analysis.UnivariateCoxPH.Group)

tbl_regression(DBP.Analysis.UnivariateCoxPH.Group, 
               exponentiate = TRUE) 


(ggforest(DBP.Analysis.UnivariateCoxPH.Group, 
          data=DBP.Analysis,
          main = "",
          fontsize = 1.5))

##################################
# Plotting the Kaplan-Meier survival curves
# for the formulated Univariate Cox Proportional Hazards Model
# involving the Factor Variable
##################################
DBP.Analysis.UnivariateCoxPH.Group.KaplanMeierEstimates <- survfit(DBP.Analysis.UnivariateCoxPH.Group, data = DBP.Analysis)

SurvivalTimeInWeek.KaplanMeier.UnivariateCoxPH.Group <- ggsurvplot(DBP.Analysis.UnivariateCoxPH.Group.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ Group)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.UnivariateCoxPH.Group,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Formulating a Univariate Cox Proportional Hazards Model
# independently for the Covariate Variable
##################################
(DBP.Analysis.UnivariateCoxPH.WBC <- coxph(Surv(Week, Status) ~ WBC, data = DBP.Analysis))

summary(DBP.Analysis.UnivariateCoxPH.WBC)

tbl_regression(DBP.Analysis.UnivariateCoxPH.WBC, 
               exponentiate = TRUE) 


(ggforest(DBP.Analysis.UnivariateCoxPH.WBC, 
          data=DBP.Analysis,
          main = "",
          fontsize = 1.5))

##################################
# Plotting the Kaplan-Meier survival curves
# for the formulated Univariate Cox Proportional Hazards Model
# involving the Covariate Variable
##################################
DBP.Analysis.UnivariateCoxPH.WBC.KaplanMeierEstimates <- survfit(DBP.Analysis.UnivariateCoxPH.WBC, data = DBP.Analysis)

SurvivalTimeInWeek.KaplanMeier.UnivariateCoxPH.WBC <- ggsurvplot(DBP.Analysis.UnivariateCoxPH.WBC.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ WBC)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.UnivariateCoxPH.WBC,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))


##################################
# Formulating a Univariate Cox Proportional Hazards Model
# individually for the Factor and Covariate Variables
##################################
tbl_survfit(
  list(survfit(Surv(Week, Status) ~ 1, data = DBP.Analysis),
       survfit(Surv(Week, Status) ~ Group, data = DBP.Analysis),
       survfit(Surv(Week, Status) ~ WBC, data = DBP.Analysis)),
  probs = 0.5,
  label_header = "**Median Survival**") %>%
  add_n() %>%
  add_nevent()

```

### 1.5.2 Multivariate Cox Proportional Hazards Model
```{r section_1.5.2, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Formulating a Multivariate Cox Proportional Hazards Model
# with both the Factor and Covariate Variables
##################################
(DBP.Analysis.MultivariateCoxPH.GroupWBC <- coxph(Surv(Week, Status) ~ Group + WBC, data = DBP.Analysis))

summary(DBP.Analysis.MultivariateCoxPH.GroupWBC )

tbl_regression(DBP.Analysis.MultivariateCoxPH.GroupWBC, 
               exponentiate = TRUE) 

(DBP.Analysis.MultivariateCoxPH.GroupWBC.ForestPlot <- ggforest(DBP.Analysis.MultivariateCoxPH.GroupWBC , 
          data=DBP.Analysis,
          main = "",
          fontsize = 1.5))

##################################
# Plotting the Kaplan-Meier survival curves
# for the formulated Multivariate Cox Proportional Hazards Model
# involving the Factor and Covariate variables
##################################
DBP.Analysis.MultivariateCoxPH.GroupWBC.KaplanMeierEstimates <- survfit(DBP.Analysis.MultivariateCoxPH.GroupWBC , data = DBP.Analysis)

SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC <- ggsurvplot(DBP.Analysis.MultivariateCoxPH.GroupWBC.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ Group + WBC)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Formulating a Multivariate Cox Proportional Hazards Model
# with both the Factor and Covariate Variables
# including their interaction
##################################
(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction <- coxph(Surv(Week, Status) ~ Group + WBC + Group*WBC, data = DBP.Analysis))

summary(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction)

tbl_regression(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction, 
               exponentiate = TRUE)

(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction.ForestPlot <- ggforest(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction, 
          data=DBP.Analysis,
          main = "",
          fontsize = 1.5))

##################################
# Plotting the Kaplan-Meier survival curves
# for the formulated Multivariate Cox Proportional Hazards Model
# involving the Factor and Covariate variables
# including their interaction
##################################
DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction.KaplanMeierEstimates <- survfit(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction, data = DBP.Analysis)

SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC.WithInteraction <- ggsurvplot(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ Group * WBC)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC.WithInteraction,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Formulating complete and reduced
# Multivariate Cox Proportional Hazards Models
# involving the Factor and Covariate Variables
##################################
DBP.Analysis.SurvivalResponse <- "Surv(Week, Status)"
DBP.Analysis.SurvivalPredictorComplete <- c("Group", "WBC")
DBP.Analysis.SurvivalPredictorReduced <- c("Group", "WBC")

DBP.Analysis.CoxPHModelSummary <- DBP.Analysis %>%
  finalfit(DBP.Analysis.SurvivalResponse, 
           DBP.Analysis.SurvivalPredictorComplete, 
           DBP.Analysis.SurvivalPredictorReduced, 
           keep_models = TRUE,
           add_dependent_label = FALSE) %>%
  rename("Overall Survival" = label) %>%
  rename(" " = levels) %>%
  rename("  " = all)

kable(DBP.Analysis.CoxPHModelSummary)

```

### 1.5.3 Model Selection
```{r section_1.5.3, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Reusing formulated models
##################################
summary(DBP.Analysis.UnivariateCoxPH.Group)
summary(DBP.Analysis.MultivariateCoxPH.GroupWBC)
summary(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction)

##################################
# Formulating the linear predictors
# for the formulated Univariate Cox Proportional Hazards Models
##################################
DBP.Analysis$LP.Univariate.Group <- predict(DBP.Analysis.UnivariateCoxPH.Group, type = "lp")

##################################
# Formulating the linear predictors
# for the formulated Multivariate Cox Proportional Hazards Models
##################################
DBP.Analysis$LP.Multivariate.GroupWBC <- predict(DBP.Analysis.MultivariateCoxPH.GroupWBC, type = "lp")
DBP.Analysis$LP.Multivariate.GroupWBC.WithInteraction <- predict(DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction, type = "lp")

##################################
# Conducting a likelihood ratio test between nested models
# including the formulated Multivariate Cox Proportional Hazards Models
# involving the Factor variable only
# and both Factor and Covariate variables
##################################
(LikelihoodRatioTest.CoxPHGroup.CoxPHGroupWBC <- anova(DBP.Analysis.UnivariateCoxPH.Group,
      DBP.Analysis.MultivariateCoxPH.GroupWBC,
      test="LRT"))

##################################
# Conducting a likelihood ratio test between nested models
# including the formulated Multivariate Cox Proportional Hazards Models
# involving both Factor and Covariate variables only
# and both Factor and Covariate variables including their interaction
##################################
(LikelihoodRatioTest.CoxPHGroupWBC.CoxPHGroupWBCWithInteraction <- anova(DBP.Analysis.MultivariateCoxPH.GroupWBC,
      DBP.Analysis.MultivariateCoxPH.GroupWBC.WithInteraction,
      test="LRT"))
```

### 1.5.4 Model Performance Validation
```{r section_1.5.4, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Measuring the Harrel's Concordance Index
# for the formulated Univariate Cox Proportional Hazards Model
# involving the Factor variable
##################################
rcorrcens(formula = Surv(Week, Status) ~ I(-1 * LP.Univariate.Group), data = DBP.Analysis)

LP.Univariate.Group.Concordance <- survConcordance(Surv(Week, Status) ~ LP.Univariate.Group,
                                               data = DBP.Analysis)

(LP.Univariate.Group.Concordance$concordance)

DBP.Analysis.UnivariateCoxPH.Group.Validation <- cph(Surv(Week, Status) ~ Group, 
                                                     x=TRUE, 
                                                     y=TRUE, 
                                                     data = DBP.Analysis)

set.seed (88888888)
DBP.Analysis.UnivariateCoxPH.Group.Validation.Summary <- validate(DBP.Analysis.UnivariateCoxPH.Group.Validation, B =500)

(DBP.Analysis.UnivariateCoxPH.Group.ConcordanceIndex.Optimistic <- (DBP.Analysis.UnivariateCoxPH.Group.Validation.Summary[1,1]/2)+0.50)
(DBP.Analysis.UnivariateCoxPH.Group.ConcordanceIndex.OptimismCorrected <- (DBP.Analysis.UnivariateCoxPH.Group.Validation.Summary[1,5]/2)+0.50)

##################################
# Measuring the Harrel's Concordance Index
# for the formulated Multivariate Cox Proportional Hazards Model
# involving the Factor and Covariate variables
##################################
rcorrcens(formula = Surv(Week, Status) ~ I(-1 * LP.Multivariate.GroupWBC), data = DBP.Analysis)

LP.Multivariate.GroupWBC.Concordance <- survConcordance(Surv(Week, Status) ~ LP.Multivariate.GroupWBC, 
                                                        data = DBP.Analysis)

(LP.Multivariate.GroupWBC.Concordance$concordance)

DBP.Analysis.Multivariate.GroupWBC.Validation <- cph(Surv(Week, Status) ~ Group + WBC, 
                                                     x=TRUE, 
                                                     y=TRUE, 
                                                     data = DBP.Analysis)

set.seed (88888888)
DBP.Analysis.Multivariate.GroupWBC.Validation.Summary <- validate(DBP.Analysis.Multivariate.GroupWBC.Validation, B =500)

(DBP.Analysis.Multivariate.GroupWBC.ConcordanceIndex.Optimistic <- (DBP.Analysis.Multivariate.GroupWBC.Validation.Summary[1,1]/2)+0.50)
(DBP.Analysis.Multivariate.GroupWBC.ConcordanceIndex.OptimismCorrected <- (DBP.Analysis.Multivariate.GroupWBC.Validation.Summary[1,5]/2)+0.50)

##################################
# Measuring the Harrel's Concordance Index
# for the formulated Multivariate Cox Proportional Hazards Model
# involving the Factor and Covariate variables
# including their interaction
##################################
rcorrcens(formula = Surv(Week, Status) ~ I(-1 * LP.Multivariate.GroupWBC.WithInteraction), data = DBP.Analysis)

LP.Multivariate.GroupWBC.WithInteraction.Concordance <- survConcordance(Surv(Week, Status) ~ LP.Multivariate.GroupWBC.WithInteraction, data = DBP.Analysis)

(LP.Multivariate.GroupWBC.WithInteraction.Concordance$concordance)

DBP.Analysis.Multivariate.GroupWBC.WithInteraction.Validation <- cph(Surv(Week, Status) ~ Group + WBC + Group*WBC, 
                                                     x=TRUE, 
                                                     y=TRUE, 
                                                     data = DBP.Analysis)

set.seed (88888888)
DBP.Analysis.Multivariate.GroupWBC.WithInteraction.Validation.Summary <- validate(DBP.Analysis.Multivariate.GroupWBC.WithInteraction.Validation, B =500)

(DBP.Analysis.Multivariate.GroupWBC.WithInteraction.ConcordanceIndex.Optimistic <- (DBP.Analysis.Multivariate.GroupWBC.WithInteraction.Validation.Summary[1,1]/2)+0.50)
(DBP.Analysis.Multivariate.GroupWBC.WithInteraction.ConcordanceIndex.OptimismCorrected <- (DBP.Analysis.Multivariate.GroupWBC.WithInteraction.Validation.Summary[1,5]/2)+0.50)

```

### 1.5.5 Model Diagnostics
```{r section_1.5.5, warning=FALSE, message=FALSE, fig.width=15, fig.height=8, fig.align="center"}
##################################
# Reusing selected model
##################################
summary(DBP.Analysis.MultivariateCoxPH.GroupWBC)

tbl_regression(DBP.Analysis.MultivariateCoxPH.GroupWBC, 
               exponentiate = TRUE) 

(DBP.Analysis.MultivariateCoxPH.GroupWBC.ForestPlot <- ggforest(DBP.Analysis.MultivariateCoxPH.GroupWBC , 
          data=DBP.Analysis,
          main = "",
          fontsize = 1.5))

##################################
# Plotting the Kaplan-Meier survival curves
# for the formulated Multivariate Cox Proportional Hazards Model
# involving the Factor and Covariate variables
##################################
DBP.Analysis.MultivariateCoxPH.GroupWBC.KaplanMeierEstimates <- survfit(DBP.Analysis.MultivariateCoxPH.GroupWBC , data = DBP.Analysis)

SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC <- ggsurvplot(DBP.Analysis.MultivariateCoxPH.GroupWBC.KaplanMeierEstimates,
                                                     title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ Group + WBC)",
                                                     pval = FALSE,
                                                     conf.int = TRUE,
                                                     conf.int.style = "ribbon",
                                                     xlab = "Time (Weeks)",
                                                     ylab="Estimated Survival Probability",
                                                     break.time.by = 5,
                                                     ggtheme = theme_bw(),
                                                     risk.table = "abs_pct",
                                                     risk.table.title="Number at Risk (Survival Probability)",
                                                     risk.table.y.text.col = FALSE,
                                                     risk.table.y.text = TRUE,
                                                     fontsize = 5,
                                                     ncensor.plot = FALSE,
                                                     surv.median.line = "hv",
                                                     palette = c("#000000"))

ggpar(SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Plotting the Kaplan-Meier survival curves
# of the Factor variable adjusted by the Covariate variable 
# using the formulated Multivariate Cox Proportional Hazards Model
##################################

(DBP.GroupAdjustedByWBC <- with(DBP.Analysis,
                                 data.frame(Group = c("Placebo", "Treatment"),
                                            WBC = rep(mean(WBC, na.rm = TRUE), 2))))


DBP.Analysis.MultivariateCoxPH.GroupWBC.GroupAdjustedByWBC.KaplanMeierEstimates <- survfit(DBP.Analysis.MultivariateCoxPH.GroupWBC, 
                                                                                             newdata = DBP.GroupAdjustedByWBC, 
                                                                                             data=DBP.Analysis)


SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC.GroupAdjustedByWBC <- ggsurvplot(DBP.Analysis.MultivariateCoxPH.GroupWBC.GroupAdjustedByWBC.KaplanMeierEstimates,
                                                                         title = "Kaplan-Meier Survival Curves (CoxPH Model : Survival ~ Group + WBC)",
                                                                         pval = TRUE,
                                                                         conf.int = TRUE,
                                                                         conf.int.style = "ribbon",
                                                                         xlab = "Time (Weeks)",
                                                                         ylab="Estimated Survival Probability",
                                                                         break.time.by = 5,
                                                                         ggtheme = theme_bw(),
                                                                         risk.table = "abs_pct",
                                                                         risk.table.title="Number at Risk (Survival Probability)",
                                                                         risk.table.y.text.col = FALSE,
                                                                         risk.table.y.text = TRUE,
                                                                         fontsize = 5,
                                                                         ncensor.plot = FALSE,
                                                                         surv.median.line = "hv",
                                                                         legend.labs = c("Placebo", "Treatment"),
                                                                         palette = c("#3259A0","#FF5050"))

ggpar(SurvivalTimeInWeek.KaplanMeier.MultivariateCoxPH.GroupWBC.GroupAdjustedByWBC,
      font.title = c(25,"bold"),
      font.x = c(20,"bold"),
      font.y = c(20,"bold"),
      font.legend=c(20,"bold"),
      font.xtickslab=c(15,"bold","black"),
      font.ytickslab=c(15,"bold","black"))

##################################
# Testing the proportional hazards assumption
# based on the scaled Schoenfield residuals
##################################
(DBP.Analysis.MultivariateCoxPH.GroupWBC.PHAssumptionCheck <- cox.zph(DBP.Analysis.MultivariateCoxPH.GroupWBC))

##################################
# Formulating the graphical verification
# of the proportional hazards assumption test results
# using the scaled Schoenfeld residuals against time
##################################
(DBP.Analysis.MultivariateCoxPH.GroupWBC.PHAssumptionPlot <- ggcoxzph(DBP.Analysis.MultivariateCoxPH.GroupWBC.PHAssumptionCheck,
         point.col = "red",
         point.size = 3,
         point.shape = 19,
         point.alpha = 0.80,
  ggtheme = theme_survminer(),
  font.main = c(25,"bold"),
  font.x = c(20,"bold"),
  font.y = c(20,"bold"),
  font.xtickslab=c(15,"bold","black"),
  font.ytickslab=c(15,"bold","black")))

##################################
# Formulating the graphical verification
# to evaluate potential influential observations
# using the deviance residuals against observations
##################################
ggcoxdiagnostics(DBP.Analysis.MultivariateCoxPH.GroupWBC, 
 type = "deviance", 
 ox.scale = "observation.id",
 point.col = "red",
 point.size = 3,
 point.shape = 19,
 point.alpha = 0.80,
 ggtheme = theme_survminer(),
 font.main = c(25,"bold"),
 font.x = c(20,"bold"),
 font.y = c(20,"bold"),
 font.xtickslab=c(15,"bold","black"),
 font.ytickslab=c(15,"bold","black"),
 main = "Deviance Residuals by Observation")

##################################
# Formulating the graphical verification
# to evaluate symmetry
# using the dfbeta residuals against observations
##################################
ggcoxdiagnostics(DBP.Analysis.MultivariateCoxPH.GroupWBC, 
 type = "dfbeta", 
 ox.scale = "observation.id",
 point.col = "red",
 point.size = 3,
 point.shape = 19,
 point.alpha = 0.80,
 ggtheme = theme_survminer(),
 font.main = c(25,"bold"),
 font.x = c(20,"bold"),
 font.y = c(20,"bold"),
 font.xtickslab=c(15,"bold","black"),
 font.ytickslab=c(15,"bold","black"),
 main = "Dfbeta Residuals by Observation")

##################################
# Formulating the graphical verification
# to evaluate linearity of the numeric covariate
# using the martingale residuals of the null cox proportional hazards model
# and the individual values of the numeric covariate 
##################################
ggcoxfunctional(Surv(Week, Status) ~ WBC, 
 data = DBP.Analysis,
 point.col = "red",
 point.size = 3,
 point.shape = 19,
 point.alpha = 0.80,
 ggtheme = theme_survminer(),
 font.main = c(25,"bold"),
 font.x = c(20,"bold"),
 font.y = c(20,"bold"),
 font.xtickslab=c(15,"bold","black"),
 font.ytickslab=c(15,"bold","black"),
 main = "Martingale Residuals by WBC")

```

# **2. References**
|
| **[Book]** [Survival Analysis : A Self-Learning Text](https://link.springer.com/book/10.1007/978-1-4419-6646-9) by David Kleinbaum and Mitchel Klein
| **[Book]** [Applied Survival Analysis Using R](https://link.springer.com/book/10.1007/978-3-319-31245-3) by Dirk Moore
| **[Book]** [R for Health Data Science](https://argoshare.is.ed.ac.uk/healthyr_book/chap10-h1.html) by Ewen Harrison and Riinu Pius
| **[Book]** [Supervised Machine Learning](https://bookdown.org/mpfoley1973/supervised-ml/) by Michael Foley
| **[Book]** [Data Science for Biological, Medical and Health Research](https://thomaselove.github.io/432-notes/index.html) by Thomas Love
| **[R Package]** [moments](https://cran.r-project.org/web/packages/moments/index.html) by Lukasz Komsta and Frederick Novomestky
| **[R Package]** [car](https://cran.r-project.org/web/packages/car/vignettes/embedding.pdf) by John Fox and Sanford Weisberg
| **[R Package]** [multcomp](https://cran.r-project.org/web/packages/multcomp/vignettes/generalsiminf.pdf) by Torsten Hothorn, Frank Bretz and Peter Westfall
| **[R Package]** [effects](https://cran.r-project.org/web/packages/effects/vignettes/methods-supported-by-effects.pdf) by John Fox and Sanford Weisberg
| **[R Package]** [psych](http://personality-project.org/r/overview.pdf) by William Revelle
| **[R Package]** [ggplot2](https://cran.r-project.org/web/packages/ggplot2/) by Hadley Wickham
| **[R Package]** [dplyr](https://cran.r-project.org/web/packages/dplyr/index.html) by Hadley Wickham
| **[R Package]** [ggpubr](https://cran.r-project.org/web/packages/ggpubr/index.html) by Alboukadel Kassambara
| **[R Package]** [rstatix](https://mran.microsoft.com/web/packages/rstatix/index.html) by Alboukadel Kassambara
| **[R Package]** [ggfortify](https://cran.r-project.org/web/packages/ggfortify/index.html) by Yuan Tang
| **[R Package]** [trend](https://cran.r-project.org/web/packages/trend/index.html) by Thorsten Pohlert
| **[R Package]** [survival](https://cran.r-project.org/web/packages/survival/) by Terry Therneau
| **[R Package]** [rms](https://cran.r-project.org/web/packages/rms/index.html) by Frank Harrell
| **[R Package]** [survminer](https://cran.r-project.org/web/packages/survminer/index.html) by Alboukadel Kassambara
| **[R Package]** [Hmisc](https://cran.r-project.org/web/packages/Hmisc/index.html) by Frank Harrel
| **[R Package]** [finalfit](https://cran.r-project.org/web/packages/finalfit/index.html) by Ewen Harrison
| **[R Package]** [knitr](https://cran.r-project.org/web/packages/knitr/) by Yihui Xie
| **[R Package]** [gtsummary](https://cloud.r-project.org/web/packages/gtsummary/index.html) by Daniel Sjoberg
| **[Article]** [Survival Analysis](http://www.sthda.com/english/wiki/survival-analysis) by Alboukadel Kassambara
| **[Article]** [Survival Analysis in R](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html) by Emily Zabor
| **[Article]** [Survival Analysis with R](https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/) by Joseph Rickert
| **[Article]** [Assessment of Discrimination in Survival Analysis](https://rstudio-pubs-static.s3.amazonaws.com/3506_36a9509e9d544386bd3e69de30bca608.html) by R-Studio Team
| **[Article]** [Cox Model Assumptions](http://www.sthda.com/english/wiki/cox-model-assumptions#testing-non-linearity) by Alboukadel Kassambara
| **[Publication]** [Regression Models and Life-Tables](https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1972.tb00899.x) by David Cox (Royal Statistical Society)
| **[Publication]** [Evaluating the Yield of Medical Tests](https://jamanetwork.com/journals/jama/article-abstract/372568) by Frank Harrell, Robert Califf, David Pryor, Kerry Lee and Robert Rosati (Journal of the American Medical Association)
| **[Publication]** [Survival Analysis Part I: Basic Concepts and First Analyses](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2394262/) by Taane Clark (British Journal of Cancer)
| **[Publication]** [Survival Analysis Part II: Multivariate Data Analysis – An Introduction to Concepts and Methods](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2394368/) by Mike Bradburn (British Journal of Cancer)
| **[Publication]** [Survival Analysis Part III: Multivariate Data Analysis – Choosing a Model and Assessing its Adequacy and Fit](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2376927/) by Mike Bradburn (British Journal of Cancer)
| **[Publication]** [Survival Analysis Part IV: Further Concepts and Methods in Survival Analysis](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2394469/) by Taane Clark (British Journal of Cancer)
| **[Tutorial]** [Survival Analysis / Time-To-Event Analysis in R](https://campus.datacamp.com/courses/survival-analysis-in-r/what-is-survival-analysis?ex=1) by Heidi Seibold (Datacamp)
|
|
|
|
|